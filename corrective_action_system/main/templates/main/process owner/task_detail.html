{% extends 'main/process owner/base.html' %}
{% load custom_tags %}
{% block title %}Non-Conformity Details{% endblock %}

{% block content %}
    <div class="container mt-4">
        <h3>Non-Conformity Details</h3>

        <!-- Progress Bar -->
        <div class="progress my-3">
            <div
                    class="progress-bar {% if immediate_action and root_cause_analysis and root_cause_analysis.root_cause_completed %}bg-success{% else %}bg-warning{% endif %}"
                    role="progressbar"
                    style="width:
                            {% if not immediate_action %}33%;
                            {% elif not root_cause_analysis or not root_cause_analysis.root_cause_completed %}66%;
                            {% else %}100%;
                            {% endif %}">
                {% if not immediate_action %}
                    Immediate Action Pending
                {% elif not root_cause_analysis or not root_cause_analysis.root_cause_completed %}
                    Root Cause Analysis Pending
                {% else %}
                    Corrective Action Plan Completed
                {% endif %}
            </div>
        </div>

        <!-- Display additional details -->
        {% if immediate_action and root_cause_analysis and root_cause_analysis.root_cause_completed %}
            <div class="alert alert-success mt-3">
                <strong>Status:</strong> This non-conformance has been completed successfully.
            </div>
        {% else %}
            <div class="alert alert-info mt-3">
                <strong>Status:</strong> This non-conformance is still in progress.
            </div>
        {% endif %}


        <!-- Flash Messages -->
        {% if messages %}
            <div>
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Non-Conformity Details Card -->
        <div class="card mt-4">
            <div class="card-body">
                <div class="row">
                    <!-- Details Columns -->
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><strong>Originator Name:</strong> {{ task.originator_name }}
                            </li>
                            <li class="list-group-item"><strong>Unit/Department:</strong> {{ task.unit_department }}
                            </li>
                            <li class="list-group-item"><strong>Phone:</strong> {{ task.phone }}</li>
                            <li class="list-group-item"><strong>Email:</strong> {{ task.email }}</li>
                            <li class="list-group-item"><strong>RFA Intent:</strong> {{ task.get_rfa_intent_display }}
                            </li>
                            <li class="list-group-item"><strong>Department:</strong> {{ task.department }}</li>
                            <li class="list-group-item"><strong>Non-Conformance
                                Category:</strong> {{ task.get_non_conformance_category_display }}</li>

                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><strong>Description of
                                Non-Conformance:</strong> {{ task.description_of_non_conformance }}</li>
                            <li class="list-group-item"><strong>ISO Clause:</strong> {{ task.iso_clause }}</li>
                            <li class="list-group-item"><strong>Category:</strong> {{ task.get_category_display }}</li>
                            <li class="list-group-item"><strong>Date Issued:</strong> {{ task.start_date }}</li>
                            <li class="list-group-item"><strong>Status:</strong> {{ task.get_status_display }}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collapsible Steps -->
        <div class="accordion mt-4" id="auditStepsAccordion">
            <!-- Immediate Action -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="immediateActionHeader">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                            data-bs-target="#immediateActionContent">
                        Immediate Action/ Correction
                    </button>
                </h2>
                <div id="immediateActionContent" class="accordion-collapse collapse show"
                     data-bs-parent="#auditStepsAccordion">
                    <div class="accordion-body">
                        <form method="post" action="{% url 'add_immediate_action' task.id %}">
                            {% csrf_token %}

                            <!-- Immediate Action Description -->
                            <textarea
                                    class="form-control mb-3"
                                    name="immediate_action"
                                    rows="4"
                                    placeholder="Describe the action"
                                    required>{{ immediate_action.action_description|default_if_none:'' }}</textarea>

                            <!-- Save Button -->
                            <button type="submit" class="btn btn-primary">Save Immediate Action</button>
                        </form>
                    </div>
                </div>
            </div>


            <!-- Root Cause Analysis -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="rootCauseHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#rootCauseContent">
                        Step 2: Root Cause Analysis
                    </button>
                </h2>
                <div id="rootCauseContent" class="accordion-collapse collapse" data-bs-parent="#auditStepsAccordion">
                    <div class="accordion-body">
                        <form method="post" action="{% url 'add_root_cause_analysis' task.id %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="rootCause" class="form-label"><strong>Root Cause:</strong></label>
                                <textarea class="form-control" id="rootCause" name="root_cause" rows="4"
                                          placeholder="Identify the root cause"
                                          required>{{ root_cause_analysis.cause_description|default_if_none:'' }}</textarea>
                            </div>
                            <div class="mb-3">
                                <label for="rcaDate" class="form-label"><strong>Date of Root Cause
                                    Analysis:</strong></label>
                                <input type="date" class="form-control" id="rcaDate" name="rca_date"
                                       value="{{ root_cause_analysis.rca_date|date:'Y-m-d' }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="responsibleOfficer" class="form-label"><strong>Responsible Officer:</strong></label>
                                <input type="text" class="form-control" id="responsibleOfficer"
                                       name="responsible_officer"
                                       value="{{ root_cause_analysis.responsible_officer|default_if_none:'' }}"
                                       required>
                            </div>
                            <div class="mb-3">
                                <label for="estimatedCloseDate" class="form-label"><strong>Estimated Close
                                    Date:</strong></label>
                                <input type="date" class="form-control" id="estimatedCloseDate"
                                       name="estimated_close_date"
                                       value="{{ root_cause_analysis.estimated_close_date|date:'Y-m-d' }}" required>
                            </div>
                            <div class="mb-3">
                                <label><strong>5 Whys Analysis:</strong></label>
                                {% if root_cause_analysis.five_whys %}
                                    {% for key, value in root_cause_analysis.five_whys.items %}
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">{{ key|title }}:</span>
                                            <input type="text" class="form-control"
                                                   name="five_whys[{{ key }}]"
                                                   value="{{ value }}"
                                                   placeholder="Provide reason for {{ key|title }}"
                                                   required>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <!-- Display Empty Fields if No Data Exists -->
                                    {% for i in "12345" %}
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">Why {{ forloop.counter }}:</span>
                                            <input type="text" class="form-control"
                                                   name="five_whys[why{{ forloop.counter }}]"
                                                   placeholder="Provide reason for Why {{ forloop.counter }}"
                                                   required>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <button type="submit" class="btn btn-primary">Save Root Cause Analysis</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Corrective Action Plan -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="correctiveActionHeader">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#correctiveActionContent">
                        Step 3: Corrective Action Plan
                    </button>
                </h2>
                <div id="correctiveActionContent" class="accordion-collapse collapse"
                     data-bs-parent="#auditStepsAccordion">
                    <div class="accordion-body">
                        <form method="post" action="{% url 'corrective_action_plan' task.id %}">
                            {% csrf_token %}
                            <table class="table table-bordered">
                                <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Activity</th>
                                    <th>Responsible Person</th>
                                    <th>Time Frame</th>
                                    <th>Resources Needed</th>
                                    <th>Result</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="cap-table-body">
                                {% for cap in corrective_action_plans %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td><input type="text" class="form-control"
                                                   name="activity_{{ forloop.counter }}" value="{{ cap.activity }}"
                                                   required></td>
                                        <td><input type="text" class="form-control"
                                                   name="responsible_person_{{ forloop.counter }}"
                                                   value="{{ cap.responsible_person }}" required></td>
                                        <td><input type="text" class="form-control"
                                                   name="time_frame_{{ forloop.counter }}" value="{{ cap.time_frame }}"
                                                   required></td>
                                        <td><input type="text" class="form-control"
                                                   name="resources_needed_{{ forloop.counter }}"
                                                   value="{{ cap.resources_needed }}" required></td>
                                        <td><input type="text" class="form-control" name="result_{{ forloop.counter }}"
                                                   value="{{ cap.result }}"></td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-link delete-row-btn" title="Delete">
                                                <i class="bi bi-trash-fill text-danger"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td>1</td>
                                        <td><input type="text" class="form-control" name="activity_1"
                                                   placeholder="Enter activity" required></td>
                                        <td><input type="text" class="form-control" name="responsible_person_1"
                                                   placeholder="Enter responsible person" required></td>
                                        <td><input type="text" class="form-control" name="time_frame_1"
                                                   placeholder="Enter time frame" required></td>
                                        <td><input type="text" class="form-control" name="resources_needed_1"
                                                   placeholder="Enter resources needed" required></td>
                                        <td><input type="text" class="form-control" name="result_1"
                                                   placeholder="Enter result"></td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-link delete-row-btn" title="Delete">
                                                <i class="bi bi-trash-fill text-danger"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            <div class="d-flex justify-content-between">
                                <button type="button" id="add-row-btn" class="btn btn-secondary btn-sm">+ Add Row
                                </button>
                                <button type="submit" class="btn btn-primary">Save Corrective Action Plan</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tableBody = document.getElementById('cap-table-body');
            const addRowBtn = document.getElementById('add-row-btn');

            // Add New Row
            addRowBtn.addEventListener('click', function () {
                const rowCount = tableBody.rows.length + 1;
                const newRow = `
                <tr>
                    <td>${rowCount}</td>
                    <td><input type="text" class="form-control" name="activity_${rowCount}" placeholder="Enter activity" required></td>
                    <td><input type="text" class="form-control" name="responsible_person_${rowCount}" placeholder="Enter responsible person" required></td>
                    <td><input type="text" class="form-control" name="time_frame_${rowCount}" placeholder="Enter time frame" required></td>
                    <td><input type="text" class="form-control" name="resources_needed_${rowCount}" placeholder="Enter resources needed" required></td>
                    <td><input type="text" class="form-control" name="result_${rowCount}" placeholder="Enter result"></td>
                    <td class="text-center">
                        <button type="button" class="btn btn-link delete-row-btn" title="Delete">
                            <i class="bi bi-trash-fill text-danger"></i>
                        </button>
                    </td>
                </tr>
            `;
                tableBody.insertAdjacentHTML('beforeend', newRow);
            });

            // Delete Row
            tableBody.addEventListener('click', function (event) {
                const target = event.target.closest('.delete-row-btn');
                if (target) {
                    const row = target.closest('tr');
                    row.remove();

                    // Re-index remaining rows
                    Array.from(tableBody.rows).forEach((row, index) => {
                        row.cells[0].innerText = index + 1;
                        row.querySelectorAll('input').forEach(input => {
                            input.name = input.name.replace(/\d+$/, index + 1);
                        });
                    });
                }
            });
        });
    </script>
{% endblock %}
