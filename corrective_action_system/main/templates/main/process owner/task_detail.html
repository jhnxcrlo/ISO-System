<!--2.3 Immediate Actions and Root Cause Recording;-->
<!--2.4 Action Plan Approval and Tracking;-->
<!--2.7 Evidence Submission;-->



{% extends 'main/process owner/base.html' %}
{% load custom_tags %}
{% block title %}Non-Conformity Details{% endblock %}

{% block content %}
<style>
    .btn {
    padding: 10px 20px;
    font-size: 1rem;
    border-radius: 5px;
        position: relative;
    overflow: hidden;
}

.btn-danger {
    background-color: #A33331;
    border-color: #A33331;
}
.btn-comment {
  border: 2px solid #A33331; /* Border in #A33331 */
  color: #A33331; /* Text color in #A33331 */
  background-color: white; /* White background */
  padding: 6px 15px; /* Adjust padding as needed */
  font-size: 16px; /* Adjust font size as needed */
  border-radius: 0 8px 8px 0; /* Rounded corners only on the right side */
  margin-right: -8px; /* Creates a gap */
  cursor: pointer;
  text-align: center;
  transition: all 0.3s ease-in-out;
}

/* Hover state */
.btn-comment:hover {
  background-color: #A33331; /* Background changes to #A33331 */
  color: white; /* Text changes to white */
  border-color: #A33331;
}

/* Focused state */
.btn-comment:focus {
  outline: none; /* Removes default outline */
  box-shadow: 0 0 5px #A33331; /* Adds a glow in #A33331 */
  border-color: #A33331;
}

/* Active state */
.btn-comment:active {
  background-color: #6F2524; /* Darker version of #A33331 */
  color: white;
  border-color: #6F2524;
  transform: scale(0.98); /* Slightly shrinks button */
}

/* Disabled state */
.btn-comment:disabled {
  background-color: #f8f8f8; /* Light gray background */
  color: #cccccc; /* Gray text */
  border-color: #cccccc; /* Gray border */
  cursor: not-allowed; /* Disabled cursor */
  opacity: 0.7;
}

    /* Button style */
.btn-view-rfa {
    display: inline-flex; /* Align icon and text in a row */
    align-items: center; /* Vertically center icon and text */
    padding: 10px 20px; /* Add padding around the button */
    border: 2px solid #A33331; /* Red border */
    background-color: transparent; /* Transparent background */
    color: #A33331; /* Red text */
    text-decoration: none; /* Remove underline from link */
    font-size: 16px; /* Adjust font size */
    font-weight: bold; /* Bold text */
    text-transform: uppercase; /* Optional: Uppercase text */
    cursor: pointer; /* Pointer cursor for clickable element */
    border-radius: 0; /* No rounded corners */
    transition: background-color 0.3s ease, color 0.3s ease, transform 0.1s ease; /* Smooth hover and active transitions */
}

/* Icon styling */
.btn-view-rfa i {
    margin-right: 10px; /* Add spacing between icon and text */
    font-size: 18px; /* Adjust icon size */
}

/* Hover state */
.btn-view-rfa:hover {
    background-color: #A33331; /* Background changes to #A33331 */
  color: white; /* Text changes to white */
  border-color: #A33331;
}

/* Active state */
.btn-view-rfa:active {
    background-color: darkred; /* Darker red background when active */
    color: white; /* White text */
    transform: scale(0.95); /* Slightly shrink for a pressed effect */
    border-color: darkred; /* Darker red border */
}

    /* Base styles for the nav link */
.nav-link-tab {
    color: #A33331; /* Text color */
    text-decoration: none; /* Remove underline */
    padding: 8px 16px; /* Add some padding for better spacing */
    font-size: 16px; /* Adjust font size */
    border-radius: 4px;
    font-weight: 500; /* Set a medium font weight */
    transition: all 0.3s ease; /* Smooth transition for hover effects */
}

/* On hover, change color and add some other effects */
.nav-link-tab:hover {
    color: #A33331; /* White color on hover */
    background-color: #f5f5f5; /* Background color on hover */
    border-radius: 4px; /* Slight rounding of corners */
    text-decoration: none; /* Remove underline on hover */
}

/* Active link style */
.nav-link-tab.active {
    font-weight: 700; /* Make the active link bold */
    text-decoration: underline; /* Underline the active link */
    color: #fff; /* White color on hover */
    background-color: #A33331; /* Background color on hover */
    border-radius: 4px; /* Slight rounding of corners */
    text-decoration: none; /* Remove underline on hover */
}

</style>

    <div class="container mt-4">
        <h3>Non-Conformity Details</h3>

        <!-- Progress Bar -->
        <div class="progress my-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated
                {% if immediate_action and root_cause_analysis and root_cause_analysis.root_cause_completed %}bg-success
                {% else %}bg-warning{% endif %}"
                role="progressbar"
                style="width:
                    {% if not immediate_action %}33%;
                    {% elif not root_cause_analysis or not root_cause_analysis.root_cause_completed %}66%;
                    {% else %}100%;
                    {% endif %}">

                {% if not immediate_action %}
                    Immediate Action Pending
                {% elif not root_cause_analysis or not root_cause_analysis.root_cause_completed %}
                    Root Cause Analysis Pending
                {% else %}
                    Corrective Action Plan Completed
                {% endif %}
            </div>
        </div>


        <!-- Display additional details -->
        {% if immediate_action and root_cause_analysis and root_cause_analysis.root_cause_completed %}
            <div class="alert alert-success mt-3">
                <strong>Status:</strong> This non-conformance has been completed successfully.
            </div>
        {% else %}
            <div class="alert alert-info mt-3">
                <strong>Status:</strong> This non-conformance is still in progress.
            </div>
        {% endif %}


        <!-- Flash Messages -->
        {% if messages %}
            <div>
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Non-Conformity Details Card -->
        <div class="card mt-4">
            <div class="card-body m-4">
                <div class="row">
                    <!-- Details Columns -->
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><strong>Originator Name:</strong> {{ task.originator_name }}
                            </li>
                            <li class="list-group-item"><strong>Unit/Department:</strong> {{ task.unit_department }}
                            </li>
                            <li class="list-group-item"><strong>Phone:</strong> {{ task.phone }}</li>
                            <li class="list-group-item"><strong>Email:</strong> {{ task.email }}</li>
                            <li class="list-group-item"><strong>RFA Intent:</strong> {{ task.get_rfa_intent_display }}
                            </li>
                            <li class="list-group-item"><strong>Department:</strong> {{ task.department }}</li>
                            <li class="list-group-item"><strong>Non-Conformance
                                Category:</strong> {{ task.get_non_conformance_category_display }}
                            </li>

                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><strong>Description of
                                Non-Conformance:</strong> {{ task.description_of_non_conformance }}
                            </li>
                            <li class="list-group-item"><strong>ISO Clause:</strong> {{ task.iso_clause }}</li>
                            <li class="list-group-item"><strong>Category:</strong> {{ task.get_category_display }}</li>
                            <li class="list-group-item"><strong>Date Issued:</strong> {{ task.start_date }}</li>
                            <li class="list-group-item"><strong>Status:</strong> {{ task.get_status_display }}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-start mt-4 d-flex align-items-center">
                    <i class="bi bi-list-check" style="font-size: 40px; margin-right: 10px;  "></i>
                    <h4 class="m-0" style="font-weight:bold;">Standard Operating Procedure</h4>
        </div>
         <div class="text-start mt-1 mb-3">
                    <a href="#" class="btn-view-rfa">
                        <i class="bi bi-arrow-right"></i> View Request For Action Form
                    </a>
                </div>

        <div class="card">
            <div class="card-body m-4">
                <!-- Tabs Navigation -->
                <ul class="nav nav-tabs nav-justified mb-3" id="auditStepsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button
                                aria-controls="immediate-action"
                                aria-selected="true"
                                class="nav-link-tab active"
                                data-bs-target="#immediate-action"
                                data-bs-toggle="tab"
                                id="immediate-action-tab"
                                role="tab"
                                type="button">
                            <strong>Immediate Action/Correction</strong>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button
                                aria-controls="root-cause"
                                aria-selected="false"
                                class="nav-link-tab"
                                data-bs-target="#root-cause"
                                data-bs-toggle="tab"
                                id="root-cause-tab"
                                role="tab"
                                type="button">
                           <strong> Step 2: Root Cause Analysis</strong>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button
                                aria-controls="corrective-action"
                                aria-selected="false"
                                class="nav-link-tab"
                                data-bs-target="#corrective-action"
                                data-bs-toggle="tab"
                                id="corrective-action-tab"
                                role="tab"
                                type="button">
                           <strong> Step 3: Corrective Action Plan</strong>
                        </button>
                    </li>
                </ul>

                <!-- Tabs Content -->
                <div class="tab-content" id="auditStepsContent">
                    <div aria-labelledby="immediate-action-tab" class="tab-pane fade show active" id="immediate-action"
                         role="tabpanel">
                        <!-- Immediate Action Form -->
                        <form action="{% url 'add_immediate_action' task.id %}" method="post">
                            {% csrf_token %}
                            <textarea
                                    class="form-control mb-3"
                                    name="immediate_action"
                                    placeholder="Describe the action"
                                    required
                                    rows="4">{{ immediate_action.action_description|default_if_none:'' }}</textarea>
                            <button type="button" class="btn btn-danger mt-2" data-bs-toggle="modal" data-bs-target="#saveImmediateActionModal">
                                Save Immediate Action
                            </button>

                        </form>

                        <!-- Comments Section -->
                        <div class="comments-section mt-4">
                            <h6><strong>Comments:</strong></h6>
                            <ul class="list-group">
                                {% for comment in immediate_action_comments %}
                                    <li class="list-group-item">
                                        <!-- Parent Comment -->
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>{{ comment.author.username }}</strong>
                                                <span class="text-muted"> - {{ comment.created_at|date:"M d, Y H:i" }}</span>
                                                <p class="mb-1">{{ comment.content }}</p>
                                            </div>
                                        </div>

                                        <!-- Replies -->
                                        {% if comment.replies.all %}
                                            <ul class="list-group mt-2 ps-4">
                                                {% for reply in comment.replies.all %}
                                                    <li class="list-group-item">
                                                        <div>
                                                            <strong>{{ reply.author.username }}</strong>
                                                            <span class="text-muted"> - {{ reply.created_at|date:"M d, Y H:i" }}</span>
                                                            <p class="mb-1">{{ reply.content }}</p>
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}

                                        <!-- Reply Form -->
                                        <form action="" method="post" class="mt-2">
                                            {% csrf_token %}
                                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                            <input type="hidden" name="section" value="immediate_action">
                                            <div class="input-group">
                                                <input type="text" name="comment_content"
                                                       class="form-control form-control-sm"
                                                       placeholder="Reply to this comment..." required>
                                                <button type="submit" class="btn btn-danger btn-sm">Reply</button>
                                            </div>
                                        </form>
                                    </li>
                                {% endfor %}
                            </ul>

                            <!-- Add Comment Form -->
                            <form action="" method="post" class="mt-3">
                                {% csrf_token %}
                                <input type="hidden" name="section" value="immediate_action">
                                <div class="input-group">
                                    <input type="text" name="comment_content" class="form-control"
                                           placeholder="Write a comment..." required>
                                    <button type="submit" class="btn-comment">Comment</button>
                                </div>
                            </form>
                        </div>
                    </div>


                    <!-- Root Cause Analysis Tab -->
                    <div aria-labelledby="root-cause-tab" class="tab-pane fade" id="root-cause" role="tabpanel">
                        <!-- Root Cause Analysis Form -->
                        <form action="{% url 'add_root_cause_analysis' task.id %}" method="post"
                              enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label" for="rootCause"><strong>Root Cause:</strong></label>
                                <textarea
                                        class="form-control"
                                        id="rootCause"
                                        name="root_cause"
                                        placeholder="Identify the root cause"
                                        required
                                        rows="4">{{ root_cause_analysis.cause_description|default_if_none:'' }}</textarea>
                            </div>
                              <!-- Date of Root Cause Analysis -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="rcaDate"><strong>Date of Root Cause Analysis:</strong></label>
                                    <input
                                        class="form-control"
                                        id="rcaDate"
                                        name="rca_date"
                                        required
                                        type="date"
                                        value="{{ root_cause_analysis.rca_date|date:'Y-m-d' }}">
                                </div>

                                <!-- Estimated Close Date -->
                                <div class="col-md-6">
                                    <label class="form-label" for="estimatedCloseDate"><strong>Estimated Close Date:</strong></label>
                                    <input
                                        class="form-control"
                                        id="estimatedCloseDate"
                                        name="estimated_close_date"
                                        required
                                        type="date"
                                        value="{{ root_cause_analysis.estimated_close_date|date:'Y-m-d' }}">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="responsibleOfficer"><strong>Responsible Officer:</strong></label>
                                <input
                                        class="form-control"
                                        id="responsibleOfficer"
                                        name="responsible_officer"
                                        required
                                        type="text"
                                        value="{{ root_cause_analysis.responsible_officer|default_if_none:'' }}">
                            </div>
                            <div class="mb-3 ">
                                <label class="form-label"><strong>Supporting Evidence:</strong></label>
                                {% if root_cause_analysis.supporting_evidence %}
                                    <p>
                                        Uploaded File:
                                        <a href="{{ root_cause_analysis.supporting_evidence.url }}" target="_blank">
                                            {{ root_cause_analysis.supporting_evidence.name }}
                                        </a>
                                    </p>
                                {% endif %}
                                <input
                                        class="form-control"
                                        type="file"
                                        name="supporting_evidence"
                                        accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.zip">
                                <small class="form-text text-muted">Upload supporting documents (PDF, Word, Excel,
                                    images, etc.).</small>
                            </div>
                            <button type="button" class="btn btn-danger mt-3 complete-step-btn w-20 mt-2" data-bs-toggle="modal" data-bs-target="#saveRootCauseModal">
                                Save Root Cause Analysis
                            </button>

                        </form>
                    
                        <!-- Root Cause Comments Section -->
                        <div class="comments-section mt-4">
                            <h6><strong>Comments:</strong></h6>
                            <ul class="list-group">
                                {% for comment in root_cause_comments %}
                                    <li class="list-group-item">
                                        <!-- Parent Comment -->
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>{{ comment.author.username }}</strong>
                                                <span class="text-muted"> - {{ comment.created_at|date:"M d, Y H:i" }}</span>
                                                <p class="mb-1">{{ comment.content }}</p>
                                            </div>
                                        </div>

                                        <!-- Replies -->
                                        {% if comment.replies.all %}
                                            <ul class="list-group mt-2 ps-4">
                                                {% for reply in comment.replies.all %}
                                                    <li class="list-group-item">
                                                        <div>
                                                            <strong>{{ reply.author.username }}</strong>
                                                            <span class="text-muted"> - {{ reply.created_at|date:"M d, Y H:i" }}</span>
                                                            <p class="mb-1">{{ reply.content }}</p>
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}

                                        <!-- Reply Form -->
                                        <form action="" method="post" class="mt-2">
                                            {% csrf_token %}
                                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                            <input type="hidden" name="section" value="root_cause_analysis">
                                            <div class="input-group">
                                                <input type="text" name="comment_content"
                                                       class="form-control form-control-sm"
                                                       placeholder="Reply to this comment..." required>
                                                <button type="submit" class="btn-comment">Reply</button>
                                            </div>
                                        </form>
                                    </li>
                                {% endfor %}
                            </ul>

                            <!-- Add New Comment Form -->
                            <form action="" method="post" class="mt-3">
                                {% csrf_token %}
                                <input type="hidden" name="section" value="root_cause_analysis">
                                <div class="input-group">
                                    <input type="text" name="comment_content" class="form-control"
                                           placeholder="Write a comment..." required>
                                    <button type="submit" class=" btn-comment">Comment</button>
                                </div>
                            </form>
                        </div>
                    </div>


                    <!-- Corrective Action Plan Tab -->
                    <div aria-labelledby="corrective-action-tab" class="tab-pane fade" id="corrective-action"
                         role="tabpanel">
                        <form action="{% url 'corrective_action_plan' task.id %}" method="post">
                            {% csrf_token %}
                            <table class="table table-bordered">
                                <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Activity</th>
                                    <th>Responsible Person</th>
                                    <th>Time Frame</th>
                                    <th>Resources Needed</th>
                                    <th>Result</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="cap-table-body">
                                {% for cap in corrective_action_plans %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td><input class="form-control" name="activity_{{ forloop.counter }}"
                                                   required
                                                   type="text" value="{{ cap.activity }}"></td>
                                        <td><input class="form-control"
                                                   name="responsible_person_{{ forloop.counter }}"
                                                   required
                                                   type="text" value="{{ cap.responsible_person }}"></td>
                                        <td><input class="form-control" name="time_frame_{{ forloop.counter }}"
                                                   required
                                                   type="text" value="{{ cap.time_frame }}"></td>
                                        <td><input class="form-control"
                                                   name="resources_needed_{{ forloop.counter }}"
                                                   required
                                                   type="text" value="{{ cap.resources_needed }}"></td>
                                        <td><input class="form-control" name="result_{{ forloop.counter }}"
                                                   type="text"
                                                   value="{{ cap.result }}"></td>
                                        <td class="text-center">
                                            <button class="btn btn-link delete-row-btn" title="Delete"
                                                    type="button">
                                                <i class="bi bi-trash-fill text-danger"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td>1</td>
                                        <td><input class="form-control" name="activity_1"
                                                   placeholder="Enter activity"
                                                   required type="text"></td>
                                        <td><input class="form-control" name="responsible_person_1"
                                                   placeholder="Enter responsible person"
                                                   required type="text"></td>
                                        <td><input class="form-control" name="time_frame_1"
                                                   placeholder="Enter time frame"
                                                   required type="text"></td>
                                        <td><input class="form-control" name="resources_needed_1"
                                                   placeholder="Enter resources needed"
                                                   required type="text"></td>
                                        <td><input class="form-control" name="result_1" placeholder="Enter result"
                                                   type="text">
                                        </td>
                                        <td class="text-center">
                                            <button class="btn btn-link delete-row-btn" title="Delete"
                                                    type="button">
                                                <i class="bi bi-trash-fill text-danger"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            <div class="d-flex justify-content-between mt-3">
                                <button class="btn btn-secondary btn-sm" id="add-row-btn" type="button">+ Add Row
                                </button>
                                <button type="button" class="btn btn-danger mt-2" data-bs-toggle="modal" data-bs-target="#saveCorrectiveActionModal">
                                    Save Corrective Action Plan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Immediate Action Save Modal -->
    <div class="modal fade" id="saveImmediateActionModal" tabindex="-1" aria-labelledby="saveImmediateActionLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveImmediateActionLabel">Confirm Save</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to save this Immediate Action?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-tertiary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-secondary" id="confirmSaveImmediateAction">Yes, Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Root Cause Analysis Save Modal -->
    <div class="modal fade" id="saveRootCauseModal" tabindex="-1" aria-labelledby="saveRootCauseLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveRootCauseLabel">Confirm Save</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to save this Root Cause Analysis?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-tertiary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-secondary" id="confirmSaveRootCause">Yes, Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Corrective Action Plan Save Modal -->
    <div class="modal fade" id="saveCorrectiveActionModal" tabindex="-1" aria-labelledby="saveCorrectiveActionLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveCorrectiveActionLabel">Confirm Save</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to save this Corrective Action Plan?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-tertiary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-secondary" id="confirmSaveCorrectiveAction">Yes, Save</button>
                </div>
            </div>
        </div>
    </div>
<script>
   document.addEventListener('DOMContentLoaded', function () {
    const saveImmediateActionButton = document.getElementById('confirmSaveImmediateAction');
    const saveRootCauseButton = document.getElementById('confirmSaveRootCause');
    const saveCorrectiveActionButton = document.getElementById('confirmSaveCorrectiveAction');

    // Save Immediate Action
    if (saveImmediateActionButton) {
        saveImmediateActionButton.addEventListener('click', function () {
            // Target form inside the #immediate-action tab container
            const form = document.querySelector('#immediate-action form');
            if (form) {
                form.submit();
            } else {
                console.log('Immediate Action Form not found! Check the selector.');
            }
        });
    }

    // Save Root Cause Analysis
    if (saveRootCauseButton) {
        saveRootCauseButton.addEventListener('click', function () {
            // Target form inside the #root-cause tab container
            const form = document.querySelector('#root-cause form');
            if (form) {
                form.submit();
            } else {
                console.log('Root Cause Form not found! Check the selector.');
            }
        });
    }

    // Save Corrective Action
    if (saveCorrectiveActionButton) {
        saveCorrectiveActionButton.addEventListener('click', function () {
            // Target form inside the #corrective-action tab container
            const form = document.querySelector('#corrective-action form');
            if (form) {
                form.submit();
            } else {
                console.log('Corrective Action Form not found! Check the selector.');
            }
        });
    }

    // ============================ Comment Section Management ============================
    function toggleVisibility(element, show = true) {
        if (element) {
            element.classList.toggle('d-none', !show);
        }
    }

    document.querySelectorAll('.reply-comment-btn').forEach(button => {
        button.addEventListener('click', function () {
            const commentId = this.dataset.commentId;
            const replyFormElement = document.getElementById(`reply-comment-form-${commentId}`);
            toggleVisibility(replyFormElement, true);
        });
    });

    document.querySelectorAll('.cancel-reply-btn').forEach(button => {
        button.addEventListener('click', function () {
            const commentId = this.dataset.commentId;
            const replyFormElement = document.getElementById(`reply-comment-form-${commentId}`);
            toggleVisibility(replyFormElement, false);
        });
    });

    // ============================ Table Row Management ============================
    const tableBody = document.getElementById('cap-table-body');
    const addRowBtn = document.getElementById('add-row-btn');

    function createNewRow(rowIndex) {
        return `
        <tr>
            <td>${rowIndex}</td>
            <td><input type="text" class="form-control" name="activity_${rowIndex}" placeholder="Enter activity" required></td>
            <td><input type="text" class="form-control" name="responsible_person_${rowIndex}" placeholder="Enter responsible person" required></td>
            <td><input type="text" class="form-control" name="time_frame_${rowIndex}" placeholder="Enter time frame" required></td>
            <td><input type="text" class="form-control" name="resources_needed_${rowIndex}" placeholder="Enter resources needed" required></td>
            <td><input type="text" class="form-control" name="result_${rowIndex}" placeholder="Enter result"></td>
            <td class="text-center">
                <button type="button" class="btn btn-link delete-row-btn" title="Delete">
                    <i class="bi bi-trash-fill text-danger"></i>
                </button>
            </td>
        </tr>
        `;
    }

    addRowBtn?.addEventListener('click', function () {
        const rowCount = tableBody?.rows.length + 1 || 1;
        const newRow = createNewRow(rowCount);
        tableBody?.insertAdjacentHTML('beforeend', newRow);
    });

    tableBody?.addEventListener('click', function (event) {
        const target = event.target.closest('.delete-row-btn');
        if (target) {
            const row = target.closest('tr');
            row.remove();

            // Re-index remaining rows
            Array.from(tableBody.rows).forEach((row, index) => {
                const newRowIndex = index + 1;
                row.cells[0].innerText = newRowIndex;
                row.querySelectorAll('input').forEach(input => {
                    input.name = input.name.replace(/\d+$/, newRowIndex);
                });
            });
        }
    });
});
</script>




{% endblock %}
