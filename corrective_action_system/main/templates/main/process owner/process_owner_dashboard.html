{% extends 'main/process owner/base.html' %}
{% block title %}To Do{% endblock %}

{% block content %}
<div class="container">
    <div class="row d-flex justify-content-center align-items-center">
        <div class="col col-xl-10">
            <!-- Greeting Section -->
            <div id="greeting-section" class="greeting-section text-left mb-4">
                <h1>Hi, <strong>{{ user.username }}!</strong></h1>
                <a class="greeting-link" href="#taskSection">Proceed to do task</a>
            </div>

            <!-- Announcements -->
            <div class="announcement-header">
                <h2>Latest Announcements</h2>
                <p class="text-muted">Stay updated with the latest news and information</p>
            </div>
            <div class="announcement-list mt-4">
                {% for announcement in announcements %}
                    <div class="card mb-4 announcement-card">
                        <div class="card-body">
                            <h5 class="card-title">{{ announcement.title }}</h5>
                            <p class="card-text">{{ announcement.body }}</p>
                            <p class="card-text"><small class="text-muted">Posted on {{ announcement.date_posted|date:"Fd, Y" }}</small></p>
                        </div>
                    </div>
                {% empty %}
                    <p>No announcements to show at the moment.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Task Section -->
<div class="container" id="taskSection">
    <div class="row d-flex justify-content-center align-items-center">
        <div class="col col-xl-10">
            <div class="task-header">
                <h1>To Do</h1>
                <div id="taskCount" class="task-info-below-header">{{ tasks.count }} tasks</div>
                <h4>Tasks Assigned to Me</h4>
            </div>

            <div class="search-bar-container mb-4">
                <input id="searchInput" class="form-control" placeholder="Search task" type="text"/>
                <select id="sortDropdown" class="form-select sort-dropdown">
                    <option value="date-desc" selected>Sort by Date (Newest First)</option>
                    <option value="date-asc">Sort by Date (Oldest First)</option>
                </select>
            </div>

            <!-- To-Do List -->
            <div id="taskList">
                {% for task in tasks %}
                <div class="card todo-card">
                    <!-- Link to the task detail page instead of opening a modal -->
                    <a href="{% url 'task_detail' task.id %}" class="stretched-link text-decoration-none">
                        <div class="todo-content">
                            <div class="task-details">
                                <h5 class="card-title">{{ task.non_conformity }}</h5>
                                <p class="card-text"><small class="text-muted">Due: {{ task.deadline }}</small></p>
                            </div>
                            <div class="badge-container"><span class="{{ task.status|lower }}-badge">{{ task.status|title }}</span></div>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const searchInput = document.getElementById('searchInput');
    const sortDropdown = document.getElementById('sortDropdown');

    // Function to filter tasks by search input
    function filterTasks() {
        const searchValue = searchInput.value.toLowerCase();
        document.querySelectorAll('.todo-card').forEach(task => {
            const taskTitle = task.querySelector('.card-title').textContent.toLowerCase();
            task.style.display = taskTitle.includes(searchValue) ? '' : 'none';
        });
        updateTaskCount();
    }

    // Function to sort tasks by date
    function sortTasks() {
        const sortValue = sortDropdown.value;
        const tasksArray = Array.from(document.querySelectorAll('.todo-card'));

        tasksArray.sort((a, b) => {
            const dateA = new Date(a.querySelector('.card-text small').textContent.split(': ')[1]);
            const dateB = new Date(b.querySelector('.card-text small').textContent.split(': ')[1]);

            return sortValue === 'date-desc' ? dateB - dateA : dateA - dateB;
        });

        tasksArray.forEach(task => {
            task.parentElement.appendChild(task);
        });
    }

    // Function to update task count
    function updateTaskCount() {
        const visibleTasks = document.querySelectorAll('.todo-card:not([style*="display: none"])');
        document.getElementById('taskCount').textContent = `${visibleTasks.length} tasks`;
    }

    // Event listeners for search and sort
    searchInput.addEventListener('input', filterTasks);
    sortDropdown.addEventListener('change', sortTasks);

    // Initial update of task count
    updateTaskCount();
});
</script>

{% endblock %}
