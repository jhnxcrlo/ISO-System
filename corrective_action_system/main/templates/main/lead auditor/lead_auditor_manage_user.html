{% extends 'main/lead auditor/base.html' %}
{% load custom_tags %}
{% block title %}Manage Users{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Manage Users</h2>

    <!-- Add and Search Users -->
    <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="input-group w-50">
        <input type="text" id="searchInput" class="form-control" placeholder="Search users by username..." onkeyup="filterUsers()">
    </div>
    <button class="btn btn-primary btn-lg" onclick="openAddUserForm()">
        <i class="fas fa-user-plus"></i> Add User
    </button>
</div>

    <!-- User Table -->
    <div class="table-responsive rounded">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-light text-center">
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                {% for user in users %}
                <tr class="text-center">
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user_roles|get_item:user.id }}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" title="Edit User" 
                                onclick="openEditUserForm('{{ user.id }}', '{{ user.username }}', '{{ user.email }}', '{{ user_roles|get_item:user.id }}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" title="Delete User" 
                                onclick="confirmDeletion('{{ user.username }}', '{% url 'delete_user' user.id %}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Hidden Add/Edit User Form -->
<form id="userForm" method="post" action="{% url 'add_user' %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="user_id" id="user_id">

    <div class="mb-3">
        <label for="id_username" class="form-label">Username</label>
        <input type="text" name="username" id="id_username" class="form-control" placeholder="Enter username" required>
    </div>

    <div class="mb-3">
        <label for="id_email" class="form-label">Email</label>
        <input type="email" name="email" id="id_email" class="form-control" placeholder="Enter email" required>
    </div>

    <div class="mb-3">
        <label for="id_role" class="form-label">Role</label>
        <select name="role" id="id_role" class="form-select" required>
            <option value="" disabled selected>Select Role</option>
            <option value="Admin">Admin</option>
            <option value="Process Owner">Process Owner</option>
            <option value="Internal Auditor">Internal Auditor</option>
            <option value="Lead Auditor">Lead Auditor</option>
            <option value="External Auditor">External Auditor</option>
        </select>
    </div>
</form>
    
    <script>
function filterUsers() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const userRows = document.querySelectorAll('#userTableBody tr'); // Use table rows instead

    userRows.forEach((row) => {
        const username = row.cells[1].textContent.toLowerCase(); // Username is in the second cell
        if (username.includes(searchValue)) {
            row.style.display = ''; // Show the row
        } else {
            row.style.display = 'none'; // Hide the row
        }
    });
}
// Confirm Deletion with SweetAlert2
function confirmDeletion(username, deleteUrl) {
    Swal.fire({
        title: `Delete User "${username}"?`,
        text: "This action cannot be undone.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Delete",
        cancelButtonText: "Cancel",
        confirmButtonColor: "#d33",
        cancelButtonColor: "#6c757d",
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = deleteUrl; // Redirect to delete URL
        }
    });
}

// Open Add User Form
function openAddUserForm() {
    const form = document.getElementById('userForm');
    form.action = "{% url 'add_user' %}";

    // Clear form fields
    document.getElementById('user_id').value = '';
    document.getElementById('id_username').value = '';
    document.getElementById('id_email').value = '';
    document.getElementById('id_role').value = '';

    showForm('Add User');
}

// Open Edit User Form
function openEditUserForm(userId, username, email, role) {
    const form = document.getElementById('userForm');
    form.action = "{% url 'edit_user' 0 %}".replace('0', userId);

    // Populate form fields
    document.getElementById('user_id').value = userId;
    document.getElementById('id_username').value = username;
    document.getElementById('id_email').value = email;
    document.getElementById('id_role').value = role;

    showForm('Edit User');
}

// Show Form in SweetAlert Modal
function showForm(title) {
    const form = document.getElementById('userForm'); // Use the original form
    form.style.display = 'block'; // Temporarily show the form

    Swal.fire({
        title: title,
        html: form, // Embed the form into SweetAlert
        showCancelButton: true,
        confirmButtonText: 'Save',
        cancelButtonText: 'Cancel',
        focusConfirm: false,
        preConfirm: () => {
            form.submit(); // Submit the form
        },
        willClose: () => {
            form.style.display = 'none'; // Hide the form after modal closes
        },
    });
}

    </script>
    
{% endblock %}
