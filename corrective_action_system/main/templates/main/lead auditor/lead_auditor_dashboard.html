{% extends 'main/lead auditor/base.html' %}
{% block title %}Lead auditor Dashboard{% endblock %}


{% block content %}
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div class="container dashboard-section">
        <div class="row g-4">
            <!-- Non-Conformities -->
            <div class="col-md-4">
                <div class="dashboard-card d-flex align-items-center">
                    <i class="bi bi-kanban-fill dashboard-icon projects-icon"></i>
                    <div class="dashboard-text ms-3 d-flex flex-column align-items-start">
                        <div class="d-flex align-items-center">
                            <!-- Dynamically display the total count -->
                            <div class="stat-number">{{ total_non_conformities_count }}</div>
                            <div class="stat-title ms-2">Non-Conformities</div>
                        </div>
                        <div class="stat-subtitle">Awaiting processing</div>
                    </div>
                </div>
            </div>

            <!-- Tasks -->
            <div class="col-md-4">
                <div class="dashboard-card d-flex align-items-center">
                    <i class="bi bi-file-earmark-text-fill dashboard-icon invoices-icon"></i>
                    <div class="dashboard-text ms-3 d-flex flex-column align-items-start">
                        <div class="d-flex align-items-center">
                            <!-- Dynamically display the OFI count -->
                            <div class="stat-number">{{ total_ofi_count }}</div>
                            <div class="stat-title ms-2">OFI</div>
                        </div>
                        <div class="stat-subtitle">Soon to be cleared</div>
                    </div>
                </div>
            </div>

            <!-- Members Card -->
            <div class="col-md-4">
                <div class="dashboard-card d-flex align-items-center" data-bs-toggle="modal"
                     data-bs-target="#membersModal" style="cursor: pointer; transition: transform 0.2s ease-in-out;">
                    <i class="bi bi-person-circle dashboard-icon members-icon"></i>
                    <div class="dashboard-text ms-3 d-flex flex-column align-items-start">
                        <div class="d-flex align-items-center">
                            <div class="stat-number" id="membersCount">{{ total_members }}</div>
                            <!-- Use total_members -->
                            <div class="stat-title ms-2">Members</div>
                        </div>
                        <div class="stat-subtitle d-flex align-items-center">
                            Hard working
                            <!-- Adding an arrow icon to indicate something clickable -->
                            <i class="bi bi-arrow-down-circle ms-2" style="font-size: 1.2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal for displaying Internal Auditors and Process Owners -->
            <div class="modal fade" id="membersModal" tabindex="-1" aria-labelledby="membersModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="membersModalLabel">Members</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <ul id="membersList" class="list-group">
                                <!-- Users will be dynamically loaded here -->
                                {% for member in members %}
                                    <li class="list-group-item">
                                        <strong>{{ member.user.username }}</strong> - {{ member.role }}
                                        - {{ member.user.email }}
                                    </li>
                                {% empty %}
                                    <li class="list-group-item text-muted">No members found.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>


    <!-- Audit Section -->
    <!-- Audit Section -->
    <div class="container-fluid mt-5">
        <div class="row">
            <!-- Donut Chart and Audit Summary -->
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-info">
                        <h4 class="report-title">
                            <i class="fas fa-clipboard-list"></i> Audit Summary
                        </h4>
                        <p>Audit Findings</p>
                        <ul>
                            <!-- Major NC -->
                            <li>
                                <span style="background-color:#8E2524; width: 15px; height: 15px; display:inline-block; margin-right:10px;"></span>
                                <span>Major NC</span> <span>{{ major_nc_count }}</span>
                            </li>
                            <!-- Minor NC -->
                            <li>
                                <span style="background-color:#F86D27; width: 15px; height: 15px; display:inline-block; margin-right:10px;"></span>
                                <span>Minor NC</span> <span>{{ minor_nc_count }}</span>
                            </li>
                            <!-- OFI (Improvement) -->
                            <li>
                                <span style="background-color:#F1D000; width: 15px; height: 15px; display:inline-block; margin-right:10px;"></span>
                                <span>OFI</span> <span>{{ ofi_count }}</span>
                            </li>
                            <!-- Good Points -->
                            <li>
                                <span style="background-color:#3BBF5D; width: 15px; height: 15px; display:inline-block; margin-right:10px;"></span>
                                <span>Good Points</span> <span>{{ good_points_count }}</span>
                            </li>
                        </ul>
                        <button class="btn btn-tertiary"
                                onclick="window.location.href='{% url 'audit_report_summary' %}'">See Details...
                        </button>
                    </div>
                    <div class="chart-canvas">
                        <canvas id="myChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- ISO Clauses Pie Chart Section -->
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-info">
                        <h4 class="report-title">
                            <i class="fas fa-file-alt"></i> ISO Clauses Compliance
                        </h4>
                        <p>Compliance Status for ISO Clauses</p>
                    </div>
                    <div class="chart-canvas">
                        <canvas id="isoClausesPieChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Get dynamic data from the Django context
        const majorNcCount = {{ major_nc_count|default:0 }};
        const minorNcCount = {{ minor_nc_count|default:0 }};
        const ofiCount = {{ ofi_count|default:0 }};
        const goodPointsCount = {{ good_points_count|default:0 }};

        // Setup chart data for Audit Summary (Major NC, Minor NC, OFI, Good Points)
        const ctx1 = document.getElementById('myChart').getContext('2d');
        const data1 = {
            labels: ['Major NC', 'Minor NC', 'OFI', 'Good Points'],
            datasets: [{
                data: [majorNcCount, minorNcCount, ofiCount, goodPointsCount],
                backgroundColor: [
                    '#8E2524',  // Major NC (Red)
                    '#F86D27',  // Minor NC (Orange - brighter)
                    '#F1A839',  // Minor NC (Orange - soft)
                    '#F1D000',  // OFI (Yellow)
                    '#3BBF5D'   // Good Points (Green)
                ],
                hoverOffset: 4
            }]
        };

        // Create the donut chart for Audit Summary
        const myChart = new Chart(ctx1, {
            type: 'doughnut',
            data: data1,
            options: {
                responsive: true,
                maintainAspectRatio: false,  // Disable the aspect ratio
                animation: {
                    duration: 0  // Disable animation for better performance
                },
                plugins: {
                    legend: {
                        display: false  // Hide default legend
                    }
                },
                cutout: '70%'  // Controls the inner radius of the donut
            }
        });

        // Setup chart data for ISO Clauses Compliance
        const ctx = document.getElementById('isoClausesPieChart').getContext('2d');
        const isoClausesPieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Clause 4: Context', 'Clause 5: Leadership', 'Clause 6: Planning'],
                datasets: [{
                    data: [{{ clause_4_compliance }}, {{ clause_5_compliance }}, {{ clause_6_compliance }}],
                    backgroundColor: ['#36A2EB', '#FF6384', '#FF9F40'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                },
            }
        });
    </script>


    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js'></script>
{% endblock %}
